name: Sync decisions from Confluence

on:
  workflow_call:
    inputs:
      role:
        description: 'AI role to extract (matches "## AI Summary — <role>" heading in Confluence)'
        required: false
        default: 'Developer'
        type: string
    secrets:
      CONFLUENCE_EMAIL:
        required: true
      CONFLUENCE_API_TOKEN:
        required: true
  workflow_dispatch:
    inputs:
      role:
        description: 'AI role to extract (matches "## AI Summary — <role>" heading in Confluence)'
        required: false
        default: 'Developer'
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v4

      - name: Checkout shared scripts
        uses: actions/checkout@v4
        with:
          repository: NXD-Solutions/.github
          path: .nxd-scripts
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: .nxd-scripts/package-lock.json

      - name: Install script dependencies
        working-directory: .nxd-scripts
        run: npm ci

      - name: Remove .nxd-scripts git directory
        run: rm -rf .nxd-scripts/.git

      - name: Run sync script
        env:
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: .nxd-scripts/node_modules/.bin/tsx .nxd-scripts/scripts/sync-decisions.ts --role ${{ inputs.role }}

      - name: Check for changes
        id: changes
        run: |
          if [ -z "$(git status --porcelain -- .claude/rules/)" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "## ✅ Nothing new to sync — \`.claude/rules/decisions-${{ inputs.role }}.md\` is already up to date." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Open PR if file changed
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automated/sync-decisions-${{ inputs.role }}
          base: main
          delete-branch: true
          add-paths: .claude/rules/
          commit-message: "Sync ${{ inputs.role }} decisions from Confluence"
          title: "automated: sync ${{ inputs.role }} decisions from 'Decision Log' in Confluence"
          body: |
            Auto-generated by the **Sync decisions from Confluence** workflow.

            Regenerates `.claude/rules/decisions-${{ inputs.role }}.md` from the `## AI Summary — ${{ inputs.role }}`
            sections on each NXD decision page in Confluence.

            Review the diff to confirm all constraints look correct, then merge.
          labels: chore
